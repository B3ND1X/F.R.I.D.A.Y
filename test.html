<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.R.I.D.AY Functional Responsive Intelligent Assistant for You</title>
    <style>
        /* CSS styles unchanged */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            justify-content: space-between;
            padding: 20px;
            position: relative;
        }
        #chat-box-container {
            width: 40%;
            margin-right: 20px;
            position: relative;
            z-index: 2;
        }
        #chat-box {
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            height: 400px;
            overflow-y: scroll;
        }
        .message {
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
        }
        .user-message {
            background-color: #d1f7ff;
            text-align: right;
        }
        .groq-response {
            background-color: #e8f8e8;
            text-align: left;
        }
        .listening {
            background-color: #fff3cd;
            text-align: center;
            font-weight: bold;
        }
        #user-input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 80%;
        }
        #send-btn {
            padding: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        #send-btn:hover {
            background-color: #0056b3;
        }
        #news-weather-container {
            width: 35%;
            display: flex;
            flex-direction: column;
            z-index: 2;
        }
        .card {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }
        #weather-info, #news-info {
            font-size: 16px;
            color: #555;
        }

        #orb {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(0, 128, 255, 0.8) 60%, rgba(0, 64, 128, 0.8) 100%);
            box-shadow: 0 0 10px rgba(0, 128, 255, 0.8), 0 0 40px rgba(0, 128, 255, 0.6);
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease-out;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div id="chat-box-container">
        <div id="chat-box"></div>
        <input type="text" id="user-input" placeholder="Type your message..." />
        <button id="send-btn">Send</button>
    </div>

    <div id="news-weather-container">
        <div class="card">
            <h2>Local Weather</h2>
            <div id="weather-info">Loading weather...</div>
        </div>

        <div class="card">
            <h2>Latest News</h2>
            <div id="news-info">Loading news...</div>
        </div>
    </div>

    <div id="orb"></div> <!-- Orb in the background -->
<script>
    const apiKey = "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"; // Groq API key
    const weatherApiKey = '80445369031848dbad520436251201'; // Weather API key
    const guardianApiKey = '962cca3b-893a-4285-969b-51e44bf81615'; // The Guardian API key
    const wakeWord = "hey friday";  // Wake word for voice activation

    let recognition;
    let isListeningForCommand = false;
    let commandBuffer = '';
    let microphonePermissionGranted = false;
    let lastGroqResponse = '';
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-btn');
    const orb = document.getElementById('orb');
    let inactivityTimeout;
    const INACTIVITY_TIMEOUT = 30000; // 30 seconds inactivity timeout
    let recognizing = false; // Flag to track recognition state

    // Web Audio API setup for capturing sound
    let audioContext, analyser, microphoneStream;
    let bufferLength;
    let dataArray;

    // Function to request microphone access (Only once)
    function requestMicrophoneAccess() {
        return new Promise((resolve, reject) => {
            if (microphonePermissionGranted) {
                resolve(true); // Already granted
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then((stream) => {
                    microphonePermissionGranted = true;
                    setUpAudioAnalysis(stream);
                    resolve(true);
                })
                .catch((err) => {
                    reject("Microphone access denied: " + err);
                });
        });
    }

    // Function to process command and execute respective skill
    function processCommand(query) {
        if (query.includes("what time is it")) {
            getCurrentTime();
        } else if (query.includes("tell me a joke")) {
            getRandomJoke();
        } else if (query.includes("convert")) {
            convertUnits(query);
        } else if (query.includes("set a timer")) {
            setTimer(query);
        } else if (query.includes("set an alarm")) {
            setAlarm(query);
        } else if (query.includes("search for")) {
            searchWeb(query);
        } else if (query.includes("weather")) {
            getWeather(query);
        } else if (query.includes("motivate me")) {
            getMotivation(query);
        } else if (query.includes("news")) {
            getLatestNews(query);
        } else if (query.includes("translate")) {
            translateText(query);
        } else {
            speakText("Sorry, I didn't understand that command.");
        }
    }

    // Set up the Web Audio API analyser
    function setUpAudioAnalysis(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;  // Size of FFT for analyzing frequency data
        bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        microphoneStream = audioContext.createMediaStreamSource(stream);
        microphoneStream.connect(analyser);

        // Start analyzing audio every 50ms
        setInterval(updateOrbSize, 50);
    }

    // Update the orb size based on microphone noise
    function updateOrbSize() {
        analyser.getByteFrequencyData(dataArray);

        // Calculate average volume
        let sum = 0;
        for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i];
        }
        let averageVolume = sum / bufferLength;

        // Map average volume to orb size
        let orbSize = Math.min(100 + averageVolume / 2, 300); // Max size 300px
        orb.style.width = orbSize + 'px';
        orb.style.height = orbSize + 'px';
    }

    // Initialize speech recognition
    function initializeSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Speech recognition is not supported by this browser.");
            return;
        }

        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;  // Continuous listening
        recognition.interimResults = false; // Do not return partial results
        recognition.lang = "en-US";
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
            console.log("Speech recognition started.");
            recognizing = true; // Set recognizing flag
            resetInactivityTimer(); // Reset inactivity timer when speech starts
        };

        recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            transcript = transcript.trim().toLowerCase();
            console.log("Transcript:", transcript);

            // Detect wake word and command
            if (transcript.includes(wakeWord) && !isListeningForCommand) {
                console.log("Wake word detected!");
                playWakeWordSound(); // Play activation sound
                isListeningForCommand = true;
                displayMessage("Listening for your command...", 'groq-response');
                commandBuffer = '';
                return; // Do not process yet, continue listening
            }

            if (isListeningForCommand && transcript && transcript !== wakeWord) {
                if (transcript.length < 3) {
                    return; // Avoid sending incomplete or very short prompts
                }

                commandBuffer = transcript;
                console.log("Captured command:", commandBuffer);

                // Process the command using the skills
                processCommand(commandBuffer);

                commandBuffer = ''; // Reset buffer after processing
                isListeningForCommand = false; // End listening for command
            }

            resetInactivityTimer(); // Reset inactivity timer after receiving speech
        };

        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            restartSpeechRecognition(); // Restart recognition on error
        };

        recognition.onend = () => {
            console.log("Speech recognition ended.");
            recognizing = false; // Reset recognizing flag
            restartSpeechRecognition(); // Restart recognition when it ends
        };

        if (!recognizing) { // Only start recognition if it's not already running
            recognition.start();
        }
    }

    // Function to restart speech recognition
    function restartSpeechRecognition() {
        console.log("Restarting speech recognition...");
        if (recognition) {
            recognition.stop(); // Stop current recognition
            recognition.start(); // Restart recognition
        }
    }

    // Function to play sound when wake word is detected
    function playWakeWordSound() {
        const audio = new Audio('activation.wav');
        audio.play();
    }

    // Send the user's input to Groq
    function sendToGroq(prompt) {
        fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${apiKey}`,
            },
            body: JSON.stringify({
                model: "llama-3.3-70b-versatile",
                messages: [{
                    role: "user",
                    content: prompt
                }]
            })
        })
        .then(response => response.json())
        .then(data => {
            displayMessage(data.choices[0].message.content, 'groq-response');
            console.log("Groq response:", data.choices[0].message.content);
            lastGroqResponse = data.choices[0].message.content;
            speakText(lastGroqResponse);
        })
        .catch(error => {
            console.error("Error:", error);
            displayMessage("Error communicating with Groq.", 'groq-response');
        });
    }

    // Display a message in the chat box
    function displayMessage(content, className) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', className);
        messageElement.textContent = content;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Handle the user's text input
    function handleUserInput() {
        const userMessage = userInput.value.trim();
        if (userMessage) {
            displayMessage(userMessage, 'user-message');
            sendToGroq(userMessage);
            userInput.value = '';
        }
    }

    // Text-to-Speech (TTS) Function
    function speakText(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        } else {
            console.log("TTS is not supported by this browser.");
        }
    }

    // Weather Fetch with Location
    function getWeather(query) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Fetch weather using the latitude and longitude
                const weatherUrl = `https://api.weatherapi.com/v1/current.json?key=${weatherApiKey}&q=${latitude},${longitude}&aqi=no`;

                fetch(weatherUrl)
                    .then(response => response.json())
                    .then(data => {
                        const temperature = data.current.temp_c;
                        const description = data.current.condition.text;
                        const weatherText = `${temperature}Â°C, ${description}`;
                        displayMessage(weatherText, 'groq-response');
                        speakText(weatherText);
                    })
                    .catch(error => {
                        console.error("Error fetching weather data:", error);
                        displayMessage("Failed to load weather.", 'groq-response');
                    });
            }, () => {
                displayMessage("Geolocation access denied.", 'groq-response');
            });
        } else {
            displayMessage("Geolocation not supported by this browser.", 'groq-response');
        }
    }

    // News Fetch - The Guardian
    function getLatestNews() {
        const guardianUrl = `https://content.guardianapis.com/search?api-key=${guardianApiKey}`;

        fetch(guardianUrl)
            .then(response => response.json())
            .then(data => {
                if (data.response && data.response.results) {
                    const articles = data.response.results;
                    let newsText = '';
                    articles.forEach((article, index) => {
                        if (index < 3) {
                            newsText += `<strong>${article.webTitle}</strong><br><a href="${article.webUrl}" target="_blank">${article.sectionName}</a><br><br>`;
                        }
                    });
                    document.getElementById('news-info').innerHTML = newsText || "No news available.";
                } else {
                    console.error("No articles available");
                    document.getElementById('news-info').textContent = "Failed to load news.";
                }
            })
            .catch(error => {
                console.error("Error fetching news data:", error);
                document.getElementById('news-info').textContent = "Failed to load news.";
            });
    }

    // Motivation Fetch
    function getMotivation() {
        const quotes = [
            "Believe in yourself and all that you are.",
            "You are capable of more than you know.",
            "The only way to do great work is to love what you do."
        ];
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        displayMessage(quote, 'groq-response');
        speakText(quote);
    }

    // Unit Conversion
    function convertUnits(query) {
        // Example: "convert 100 kilometers to miles"
        const regex = /convert (\d+)\s+(\w+)\s+to\s+(\w+)/i;
        const match = query.match(regex);
        
        if (match) {
            const value = parseFloat(match[1]);
            const fromUnit = match[2].toLowerCase();
            const toUnit = match[3].toLowerCase();
            
            let conversionResult;

            if (fromUnit === "kilometers" && toUnit === "miles") {
                conversionResult = value * 0.621371;
            } else if (fromUnit === "miles" && toUnit === "kilometers") {
                conversionResult = value / 0.621371;
            } else if (fromUnit === "celsius" && toUnit === "fahrenheit") {
                conversionResult = (value * 9/5) + 32;
            } else if (fromUnit === "fahrenheit" && toUnit === "celsius") {
                conversionResult = (value - 32) * 5/9;
            }

            if (conversionResult !== undefined) {
                const message = `${value} ${fromUnit} is equal to ${conversionResult} ${toUnit}.`;
                displayMessage(message, 'groq-response');
                speakText(message);
            } else {
                displayMessage("Sorry, I couldn't convert those units.", 'groq-response');
                speakText("Sorry, I couldn't convert those units.");
            }
        } else {
            displayMessage("Please provide a valid unit conversion command.", 'groq-response');
            speakText("Please provide a valid unit conversion command.");
        }
    }

    // Set Timer (Real Implementation)
    function setTimer(query) {
        const regex = /set a timer for (\d+) (minutes|seconds)/i;
        const match = query.match(regex);

        if (match) {
            const time = parseInt(match[1]);
            const unit = match[2];
            let timeInMs = unit === "minutes" ? time * 60 * 1000 : time * 1000;
            
            setTimeout(() => {
                const message = `Your ${time} ${unit} timer has finished!`;
                displayMessage(message, 'groq-response');
                speakText(message);
            }, timeInMs);

            const message = `Timer set for ${time} ${unit}.`;
            displayMessage(message, 'groq-response');
            speakText(message);
        } else {
            displayMessage("Please specify a valid time format, e.g., 'set a timer for 5 minutes'.", 'groq-response');
            speakText("Please specify a valid time format.");
        }
    }

    // Set Alarm (Real Implementation)
    function setAlarm(query) {
        const regex = /set an alarm for (\d{1,2}):(\d{2})(?: (AM|PM))?/i;
        const match = query.match(regex);

        if (match) {
            let hours = parseInt(match[1]);
            let minutes = parseInt(match[2]);
            let period = match[3] || "AM";
            
            if (period === "PM" && hours !== 12) hours += 12;
            if (period === "AM" && hours === 12) hours = 0;

            const now = new Date();
            const alarmTime = new Date(now.setHours(hours, minutes, 0, 0));

            const timeUntilAlarm = alarmTime - Date.now();

            if (timeUntilAlarm > 0) {
                setTimeout(() => {
                    const message = `Your alarm for ${match[1]}:${match[2]} ${period} has gone off!`;
                    displayMessage(message, 'groq-response');
                    speakText(message);
                }, timeUntilAlarm);
                
                const message = `Alarm set for ${match[1]}:${match[2]} ${period}.`;
                displayMessage(message, 'groq-response');
                speakText(message);
            } else {
                displayMessage("The alarm time has already passed. Please set a future time.", 'groq-response');
                speakText("The alarm time has already passed. Please set a future time.");
            }
        } else {
            displayMessage("Please specify a valid time format, e.g., 'set an alarm for 7:30 PM'.", 'groq-response');
            speakText("Please specify a valid time format.");
        }
    }

    // Setup and initialize the assistant when the page loads
    window.onload = function () {
        getWeather();    // Fetch weather when the page loads
        getLatestNews(); // Fetch latest news when the page loads
        requestMicrophoneAccess().then(() => {
            initializeSpeechRecognition(); // Initialize speech recognition after microphone access is granted
        }).catch((error) => {
            console.error(error);
            alert("Assistant cannot run without microphone access.");
        });

        sendButton.addEventListener('click', handleUserInput);
    };
</script>


</body>
</html>
